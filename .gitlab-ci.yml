stages:
  - generate
  - build

generate-child-pipeline:
  stage: generate
  image: alpine:3.20
  script:
    - apk add --no-cache bash
    - set -euo pipefail
    - set -a && source versions.env && set +a
    - cat > child-pipeline.yml <<EOF
stages:
  - build

pages:
  stage: build
  image: node:${NODE_VERSION}-bullseye
  variables:
    HUGO_ENV: production
  cache:
    paths:
      - node_modules/
  before_script:
    - apt-get update && apt-get install -y curl ca-certificates tar git
    - curl -sSLo hugo.tar.gz "https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.tar.gz"
    - tar -xzf hugo.tar.gz
    - mv hugo /usr/local/bin/hugo
    - rm -f hugo.tar.gz
    - curl -sSLo go.tar.gz "https://storage.googleapis.com/golang/go${GO_VERSION}.linux-amd64.tar.gz"
    - tar -C /usr/local -xzf go.tar.gz
    - rm -f go.tar.gz
    - export PATH=\$PATH:/usr/local/go/bin
    - npm install
  script:
    - npm run build
  artifacts:
    paths:
      - public
EOF
  artifacts:
    paths:
      - child-pipeline.yml

trigger-child:
  stage: build
  trigger:
    include:
      - artifact: child-pipeline.yml
        job: generate-child-pipeline
    strategy: depend